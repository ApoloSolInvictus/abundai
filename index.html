<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABUNDA PRIME | Inteligencia Jurídica</title>

	<link rel="icon" type="image/png" href="/my-favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/my-favicon/favicon.svg" />
    <link rel="shortcut icon" href="/my-favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/my-favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="ProfCR" />
    <link rel="manifest" href="/my-favicon/site.webmanifest" />

    <title>ABUNDA AI | Inteligencia Empresarial Segura</title>
    <meta name="description" content="El Sistema Operativo de Conocimiento para empresas modernas. Centraliza documentos, entrena a tu equipo y obtén respuestas instantáneas con IA privada.">
    <meta name="keywords" content="abunda, ai, ia, abunda ai, documents, pdf, llm, ai for documents, ai for business, ai for sme, ai for big companies">
	<link rel="canonical" href="https://ventas.abunda-ai.com/" />

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ventas.abunda-ai.com/">
	<meta property="og:title" content="ABUNDA AI | Inteligencia Empresarial Segura">
    <meta property="og:description" content="El Sistema Operativo de Conocimiento para empresas modernas. Centraliza documentos, entrena a tu equipo y obtén respuestas instantáneas con IA privada.">
    <meta property="og:image" content="https://ventas.abunda-ai.com/images/seo-preview.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="ABUNDA AI">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://ventas.abunda-ai.com/">
    <meta property="twitter:title" content="ABUNDA AI | Inteligencia Empresarial Segura">
    <meta property="twitter:description" content="El Sistema Operativo de Conocimiento para empresas modernas. Centraliza documentos, entrena a tu equipo y obtén respuestas instantáneas con IA privada.">
    <meta property="twitter:image" content="https://ventas.abunda-ai.com/images/seo-preview.jpg">

	<link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
	<meta name="theme-color" content="#ffffff">

    <!-- Librerías Tácticas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300&display=swap" rel="stylesheet">

    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Herramientas de Documentos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        prime: {
                            dark: '#0B1120',
                            panel: '#151e32',
                            gold: '#D4AF37',
                            goldLight: '#F3E5AB',
                            text: '#E2E8F0',
                            muted: '#94A3B8'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0B1120; color: #E2E8F0; }
        
        /* Estilos del Documento Legal Renderizado */
        .markdown-body {
            font-family: 'Merriweather', serif;
            color: #1a202c;
            line-height: 1.8;
            font-size: 1.05rem;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: #0f172a; margin-top: 1.5em; margin-bottom: 0.8em; font-weight: 700;
        }
        .markdown-body h1 { font-size: 1.8em; border-bottom: 2px solid #D4AF37; padding-bottom: 10px; }
        .markdown-body h2 { font-size: 1.4em; }
        .markdown-body strong { color: #000; font-weight: 900; }
        .markdown-body ul, .markdown-body ol { margin-bottom: 1em; padding-left: 1.5em; }
        .markdown-body ul { list-style-type: disc; }
        .markdown-body li { margin-bottom: 0.5em; }
        .markdown-body blockquote {
            border-left: 4px solid #D4AF37;
            padding-left: 1em;
            color: #475569;
            font-style: italic;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1.5em 0;
        }

        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar Premium */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0B1120; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D4AF37; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">
    <div id="root" class="w-full h-full flex"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // CONFIGURACIÓN TÁCTICA
        // ==========================================
        
        // SOBERANO: REEMPLACE ESTA URL CON SU APP DE HEROKU (Backend Legal)
        const DEFAULT_BACKEND_URL = "https://infinity-1a8b0e60d47c.herokuapp.com"; 

        // CONFIGURACIÓN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyC8Qqq7F1kGvaNlTzL5gRQWTdMBVjuEamQ", 
            authDomain: "abunda-ai.firebaseapp.com",
            projectId: "abunda-ai",
            storageBucket: "abunda-ai.firebasestorage.app",
            messagingSenderId: "G-4XZ8WVKSL1",
            appId: "1:833878539166:web:01a3726d456efd3bbb348f"
        };

        let db = null;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch(e) { console.error("Error Firebase:", e); }

        // ==========================================
        // COMPONENTES
        // ==========================================

        const LoginScreen = ({ onLoginSuccess }) => {
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError("");
                try {
                    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                    onLoginSuccess(userCredential.user);
                } catch (err) {
                    setError("Credenciales no reconocidas en el sistema.");
                    setLoading(false);
                }
            };

            return (
                <div className="w-full h-full flex items-center justify-center bg-prime-dark relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] opacity-20"></div>
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-prime-gold to-transparent opacity-50"></div>

                    <div className="bg-prime-panel p-10 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md relative z-10 fade-in">
                        <div className="text-center mb-8">
                            <i className="ph ph-scales text-5xl text-prime-gold mb-4"></i>
                            <h1 className="text-3xl font-serif font-bold text-white tracking-wide">ABUNDA <span className="text-prime-gold">PRIME</span></h1>
                            <p className="text-xs text-prime-muted uppercase tracking-[0.2em] mt-2">Inteligencia Jurídica Superior</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div className="relative">
                                <i className="ph ph-user absolute left-4 top-4 text-slate-500"></i>
                                <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-prime-dark border border-slate-700 rounded-lg py-3.5 pl-12 pr-4 text-white focus:border-prime-gold outline-none transition" placeholder="Licenciado(a)" />
                            </div>
                            <div className="relative">
                                <i className="ph ph-lock-key absolute left-4 top-4 text-slate-500"></i>
                                <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-prime-dark border border-slate-700 rounded-lg py-3.5 pl-12 pr-4 text-white focus:border-prime-gold outline-none transition" placeholder="Clave de Acceso" />
                            </div>
                            
                            {error && <div className="text-red-400 text-xs text-center">{error}</div>}

                            <button disabled={loading} className="w-full py-4 bg-gradient-to-r from-yellow-700 to-yellow-600 hover:from-prime-gold hover:to-yellow-500 text-white font-bold rounded-lg transition shadow-lg flex justify-center gap-2 items-center uppercase tracking-wider text-sm">
                                {loading ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph ph-sign-in"></i>} Acceder al Bufete
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const MainWorkspace = ({ user, onLogout }) => {
            const [query, setQuery] = useState("");
            const [loading, setLoading] = useState(false);
            const [activeResult, setActiveResult] = useState(null);
            const [history, setHistory] = useState([]);
            
            // Simulación de carga inicial de historial (si estuviera en BD)
            useEffect(() => {
                // Aquí podríamos cargar historial real de Firestore
            }, []);

            const executeQuery = async () => {
                if(!query.trim()) return;
                setLoading(true);
                
                // Agregamos al historial visual local
                const newHistoryItem = { role: 'user', content: query };
                setHistory(prev => [...prev, newHistoryItem]);

                try {
                    // Enviamos al Backend de OpenAI
                    const response = await fetch(`${DEFAULT_BACKEND_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: query,
                            // Enviamos un historial limpio o limitado para enfoque en la consulta actual
                            history: history.slice(-4) 
                        })
                    });

                    if(!response.ok) throw new Error("Error en el servidor jurídico");

                    const data = await response.json();
                    
                    // Renderizamos el resultado
                    const resultHtml = marked.parse(data.response);
                    
                    const aiResponse = { 
                        role: 'ai', 
                        content: data.response, 
                        html: resultHtml,
                        timestamp: new Date()
                    };
                    
                    setActiveResult(aiResponse);
                    setHistory(prev => [...prev, aiResponse]);
                    setQuery(""); // Limpiar búsqueda

                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const downloadPDF = () => {
                const element = document.getElementById('legal-document');
                const opt = {
                    margin: 20,
                    filename: 'Dictamen_Juridico_Abunda.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(element).save();
            };

            return (
                <div className="flex w-full h-full">
                    
                    {/* SIDEBAR */}
                    <aside className="w-80 bg-prime-panel border-r border-slate-800 flex flex-col z-20 shadow-xl hidden md:flex">
                        <div className="h-20 flex items-center px-6 border-b border-slate-700/50">
                            <i className="ph ph-scales text-prime-gold text-2xl mr-3"></i>
                            <span className="font-serif font-bold text-lg tracking-wide text-white">ABUNDA <span className="text-prime-gold">PRIME</span></span>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            <button onClick={() => setActiveResult(null)} className="w-full py-3 bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-600 hover:to-blue-500 text-white rounded-lg font-bold flex items-center justify-center gap-2 shadow-lg transition">
                                <i className="ph ph-plus-circle text-lg"></i> Nuevo Caso
                            </button>

                            <div className="mt-8">
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 px-2">Consultas Recientes</p>
                                <div className="space-y-1">
                                    {history.filter(h => h.role === 'user').slice().reverse().map((h, i) => (
                                        <div key={i} className="px-3 py-2 text-sm text-slate-400 hover:bg-white/5 hover:text-white rounded cursor-pointer truncate transition border-l-2 border-transparent hover:border-prime-gold">
                                            {h.content}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t border-slate-700/50 bg-black/20">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-prime-gold text-black font-bold flex items-center justify-center">{user.email[0].toUpperCase()}</div>
                                    <div className="text-xs">
                                        <p className="text-white font-medium truncate max-w-[100px]">{user.email}</p>
                                        <p className="text-green-500">Licencia Activa</p>
                                    </div>
                                </div>
                                <button onClick={onLogout} className="text-slate-500 hover:text-red-400 transition"><i className="ph ph-sign-out text-xl"></i></button>
                            </div>
                        </div>
                    </aside>

                    {/* MAIN AREA */}
                    <main className="flex-1 flex flex-col bg-slate-100 relative">
                        
                        {/* SEARCH HEADER */}
                        <header className="h-20 bg-white border-b border-slate-200 flex items-center px-8 shadow-sm z-10 sticky top-0">
                            <div className="flex-1 max-w-4xl mx-auto relative group">
                                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i className={`ph ph-magnifying-glass text-xl ${loading ? 'text-prime-gold animate-pulse' : 'text-slate-400'}`}></i>
                                </div>
                                <input 
                                    type="text" 
                                    value={query}
                                    onChange={e=>setQuery(e.target.value)}
                                    onKeyPress={e=>e.key === 'Enter' && executeQuery()}
                                    className="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:border-prime-gold focus:ring-1 focus:ring-prime-gold/50 transition font-serif placeholder:font-sans"
                                    placeholder="Ej: Jurisprudencia sobre despido injustificado artículo 85..."
                                    disabled={loading}
                                    autoFocus
                                />
                                <button onClick={executeQuery} disabled={loading} className="absolute right-2 top-2 bottom-2 px-4 bg-prime-dark text-white rounded-lg text-sm font-bold hover:bg-slate-700 transition disabled:opacity-50">
                                    {loading ? "Analizando..." : "Consultar"}
                                </button>
                            </div>
                        </header>

                        {/* CONTENT AREA */}
                        <div className="flex-1 overflow-y-auto p-8 bg-slate-100 scroll-smooth">
                            
                            {!activeResult && !loading && (
                                <div className="h-full flex flex-col items-center justify-center text-center opacity-60">
                                    <i className="ph ph-books text-6xl text-slate-300 mb-6"></i>
                                    <h2 className="text-3xl font-serif font-bold text-slate-700 mb-2">Biblioteca Jurídica Inteligente</h2>
                                    <p className="text-slate-500 max-w-md">Acceso instantáneo a la Constitución, Códigos y Jurisprudencia de Costa Rica a través de IA.</p>
                                    <div className="mt-8 flex gap-3 text-xs font-medium text-slate-500">
                                        <span className="px-3 py-1 bg-white border border-slate-200 rounded-full">Constitución Política</span>
                                        <span className="px-3 py-1 bg-white border border-slate-200 rounded-full">Código Civil</span>
                                        <span className="px-3 py-1 bg-white border border-slate-200 rounded-full">Sala IV</span>
                                    </div>
                                </div>
                            )}

                            {loading && !activeResult && (
                                <div className="h-full flex flex-col items-center justify-center">
                                    <div className="w-16 h-16 border-4 border-slate-200 border-t-prime-gold rounded-full animate-spin mb-4"></div>
                                    <p className="text-slate-600 font-serif animate-pulse">Consultando bases legales...</p>
                                </div>
                            )}

                            {activeResult && (
                                <div className="max-w-4xl mx-auto fade-in pb-20">
                                    
                                    {/* Toolbar */}
                                    <div className="flex justify-between items-center mb-6">
                                        <span className="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                                            <i className="ph ph-check-circle"></i> Análisis Completado
                                        </span>
                                        <div className="flex gap-2">
                                            <button onClick={() => {navigator.clipboard.writeText(activeResult.content); alert("Texto copiado");}} className="p-2 bg-white border border-slate-200 rounded hover:bg-slate-50 text-slate-600" title="Copiar Texto"><i className="ph ph-copy"></i></button>
                                            <button onClick={downloadPDF} className="px-4 py-2 bg-red-600 text-white rounded font-bold text-sm hover:bg-red-500 shadow-lg flex items-center gap-2">
                                                <i className="ph ph-file-pdf"></i> Exportar Dictamen PDF
                                            </button>
                                        </div>
                                    </div>

                                    {/* Document Paper */}
                                    <div id="legal-document" className="bg-white p-12 md:p-16 rounded shadow-xl min-h-[800px] border border-slate-200 relative">
                                        
                                        {/* Membrete Simulado */}
                                        <div className="border-b-2 border-prime-gold pb-4 mb-8 flex justify-between items-end">
                                            <div>
                                                <h1 className="font-serif font-bold text-2xl text-slate-900">DICTAMEN JURÍDICO</h1>
                                                <p className="text-xs text-slate-500 mt-1">Generado por Abunda Prime AI</p>
                                            </div>
                                            <div className="text-right text-xs text-slate-500">
                                                <p>{new Date().toLocaleDateString('es-CR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                <p>San José, Costa Rica</p>
                                            </div>
                                        </div>

                                        {/* Contenido Renderizado */}
                                        <div className="markdown-body" dangerouslySetInnerHTML={{__html: activeResult.html}}></div>

                                        {/* Pie de Página */}
                                        <div className="mt-20 pt-8 border-t border-slate-100 text-center text-xs text-slate-400 italic">
                                            Este documento ha sido generado mediante inteligencia artificial para fines de investigación jurídica. Se recomienda la revisión final por un profesional colegiado.
                                        </div>
                                    </div>

                                </div>
                            )}

                        </div>
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            useEffect(() => {
                firebase.auth().onAuthStateChanged(u => setUser(u || null));
            }, []);
            return <React.Fragment>{!user ? <LoginScreen onLoginSuccess={setUser} /> : <MainInterface user={user} onLogout={() => firebase.auth().signOut()} />}</React.Fragment>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
